# 分支管理工具 - 产品文档

## 1. 产品简介
**分支管理工具** 是一款专为研发工程师和 DevOps 设计的轻量级 Git 同步管理系统。它解决了多仓库、多分支之间代码同步繁琐、缺乏记录、难以自动化的痛点。通过统一的 Web 界面，用户可以轻松配置同步规则，实现代码在不同远程仓库（如 `origin` 到 `ky`）之间的自动化流转。

## 2. 核心功能

### 2.1 仓库管理
- **本地仓库注册**：支持注册服务器上的本地 Git 仓库路径。
- **自动检测**：注册时自动校验路径是否为有效的 Git 仓库。

### 2.2 多仓同步管理
- **灵活规则**：支持定义 `源仓库/Remote/分支` 到 `目标仓库/Remote/分支` 的同步流向。
- **定时同步**：内置 Cron 调度器，支持 Cron 表达式（如 `0 2 * * *`）实现自动化周期同步。
- **手动触发**：支持一键立即执行多仓同步。
- **高级选项**：支持配置 `git push` 参数（如 `--force`, `--no-verify`）。
- **任务编辑**：支持随时调整现有任务的配置信息。

### 2.3 执行引擎与安全
- **冲突检测**：同步前自动检测 Commit 历史，防止非 Fast-Forward 更新覆盖代码（除非显式配置 Force Push）。
- **Webhooks**：提供安全接口（HMAC 签名、限流），支持外部系统（如 CI/CD、GitLab Webhook）触发同步。

### 2.4 可观测性
- **同步历史**：完整记录每次同步的执行时间、状态、Commit 区间。
- **详细日志**：提供详尽的执行日志，包含 Fetch、Hash 对比、Push 等每一步的命令输出，便于排查问题。

## 3. 技术架构
- **后端**：Go (Golang) + CloudWeGo Hertz (高性能 HTTP 框架)
- **数据库**：SQLite (轻量级，无需额外部署) + GORM
- **前端**：HTML5 + Bootstrap 5 (简洁响应式界面)
- **Git 操作**：基于 `os/exec` 调用原生 Git 命令，确保行为一致性。

---

# 用户使用手册

## 1. 快速开始

### 1.1 启动服务
在项目根目录下执行：
```bash
./git-sync-tool
```
服务默认监听端口：`8080`

### 1.2 访问界面
打开浏览器访问：[http://localhost:8080](http://localhost:8080)

## 2. 功能操作指南

### 2.1 注册仓库 (Repositories)
1. 点击导航栏的 **“仓库管理”**。
2. 点击 **“注册仓库”** 按钮。
3. 输入仓库 **名称**（便于识别）和 **本地绝对路径**（服务器上存在的 Git 仓库路径）。
4. 点击保存。

### 2.2 创建多仓同步 (Sync Tasks)
1. 点击导航栏的 **“多仓同步”**。
2. 点击 **“新建任务”**。
3. 填写配置：
    - **源仓库**：选择已注册的仓库。
    - **源 Remote/分支**：如 `origin` / `main`。
    - **目标 Remote/分支**：如 `ky` / `main`。
    - **Push 选项**（可选）：如需强制覆盖，可填 `--force`。
    - **Cron 表达式**（可选）：如 `*/10 * * * *` 表示每 10 分钟同步一次。留空则仅支持手动触发。
    - **启用**：勾选后 Cron 任务即刻生效。
4. 点击保存。

### 2.3 执行与调试
- **手动运行**：在任务列表中点击 **“运行”** 按钮，系统将在后台异步执行同步。
- **编辑任务**：点击 **“编辑”** 按钮可修改任务配置。

### 2.4 查看历史与日志
1. 点击导航栏的 **“同步历史”**。
2. 列表显示最近的同步记录，状态说明：
    - <span style="color:green">success</span>: 同步成功（或无需同步）。
    - <span style="color:orange">conflict</span>: 检测到冲突（非 Fast-Forward），且未开启强制推送。
    - <span style="color:red">failed</span>: 执行出错（网络问题、权限问题等）。
3. 点击 **“查看日志”** 按钮，可查看该次执行的完整命令行输出日志。

## 3. Webhook 集成指南
外部系统可通过 HTTP POST 请求触发多仓同步。

- **URL**: `http://<server>:8080/api/webhooks/task-sync`
- **Method**: `POST`
- **Headers**:
    - `Content-Type`: `application/json`
    - `X-Hub-Signature-256`: `sha256=<HMAC-SHA256 Signature>`
- **Body**: `{"task_id": 1}`

*注：详细 Webhook 开发文档请参考 `docs/webhook.md`。*
