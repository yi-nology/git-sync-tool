<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>度量 - 分支管理工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .container { max_width: 1000px; margin-top: 20px; }
        .card { margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="row mb-3">
            <div class="col-md-3">
                <label class="form-label">选择仓库</label>
                <select class="form-select" id="statsRepoSelect" onchange="loadStatsBranches()"></select>
            </div>
            <div class="col-md-3">
                <label class="form-label">选择分支</label>
                <select class="form-select" id="statsBranchSelect" onchange="loadStatsData()"></select>
            </div>
            <div class="col-md-2">
                <label class="form-label">选择提交人</label>
                <select class="form-select" id="statsAuthorSelect" onchange="loadStatsData()">
                    <option value="">全部</option>
                </select>
            </div>
            <div class="col-md-2">
                 <label class="form-label">开始日期</label>
                 <input type="date" class="form-control" id="statsSince">
            </div>
            <div class="col-md-2">
                 <label class="form-label">结束日期</label>
                 <input type="date" class="form-control" id="statsUntil">
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button class="btn btn-primary w-100" onclick="loadStatsData()"><i class="bi bi-search"></i></button>
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button class="btn btn-outline-success w-100" onclick="exportStatsCSV()" title="导出 CSV"><i class="bi bi-download"></i></button>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center text-bg-primary mb-3">
                    <div class="card-body">
                        <h5 class="card-title">总有效行数</h5>
                        <h2 class="display-6" id="totalLines">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center text-bg-success mb-3">
                    <div class="card-body">
                        <h5 class="card-title">活跃贡献者</h5>
                        <h2 class="display-6" id="totalAuthors">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">贡献分布 (有效行数)</h5>
                        <div id="pieChart" style="height: 350px;"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">贡献趋势 (近30天)</h5>
                        <div id="lineChart" style="height: 350px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Commits Table -->
        <div class="card">
            <div class="card-header">提交历史 (最近 100 条)</div>
            <div class="card-body">
                 <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Hash</th>
                            <th>作者</th>
                            <th>时间</th>
                            <th>信息</th>
                        </tr>
                    </thead>
                    <tbody id="commitsList">
                        <tr><td colspan="4" class="text-center">请选择仓库和分支进行分析</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="js/request.js"></script>
    <script src="js/toast.js"></script>
    <script src="js/common.js"></script>
    <script src="js/navbar.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            initToastContainer();
            loadStatsRepos();
        });

        async function loadStatsRepos() {
            try {
                const repos = await request('/repos');
                const select = document.getElementById('statsRepoSelect');
                if (!select) return;
                select.innerHTML = '<option value="">请选择...</option>';
                repos.forEach(repo => {
                    select.innerHTML += `<option value="${repo.key}">${repo.name}</option>`;
                });
            } catch (e) {
                // Handled by request.js
            }
        }
        
        async function loadStatsBranches() {
            const repoKey = document.getElementById('statsRepoSelect').value;
            if (!repoKey) return;
            
            try {
                const branches = await request(`/stats/branches?repo_key=${repoKey}`);
                const select = document.getElementById('statsBranchSelect');
                select.innerHTML = '';
                branches.forEach(b => {
                    select.innerHTML += `<option value="${b}">${b}</option>`;
                });
                
                // Auto select main/master if exists
                if (branches.includes('main')) select.value = 'main';
                else if (branches.includes('master')) select.value = 'master';
                
                loadStatsData();
            } catch (e) {
                // Handled by request.js
            }
        }
        
        let pieChart = null;
        let lineChart = null;
        let allAuthors = []; // Cache all authors for filtering
        
        async function loadStatsData() {
            const repoKey = document.getElementById('statsRepoSelect').value;
            const branch = document.getElementById('statsBranchSelect').value;
            const author = document.getElementById('statsAuthorSelect').value;
            const since = document.getElementById('statsSince').value;
            const until = document.getElementById('statsUntil').value;
            
            if (!repoKey || !branch) return;
            
            const btn = document.querySelector('button[onclick="loadStatsData()"]');
            // Check if btn exists (it might be the search icon button now)
            if (btn) {
                btn.disabled = true;
            }

            try {
                // If author is selected, we filter locally or pass to backend?
                // Backend supports filtering now. But to populate the dropdown initially, we need full data.
                // Strategy:
                // 1. If it's a new repo/branch selection (or forced refresh), fetch ALL data.
                // 2. Populate author dropdown from ALL data.
                // 3. If author filter is active, filter the data (either frontend or backend).
                // Let's rely on backend filtering for consistency with CSV export.
                
                let url = `/stats/analyze?repo_key=${repoKey}&branch=${encodeURIComponent(branch)}&since=${since}&until=${until}`;
                // Only fetch full list if we don't have authors yet or params changed significantly?
                // Actually, backend calculation is heavy. Maybe we should fetch full stats once, then filter in frontend?
                // But the user asked for "group by submitter selection", implying backend filter or view filter.
                // Backend implementation added 'author' param. Let's use it.
                // Wait, if we use backend filter, we can't populate the dropdown initially unless we have a separate "list authors" API.
                // OR: We fetch full stats first (author=""), populate dropdown, then apply filter if user selects one?
                // If the user selects an author, we re-fetch with author param? That triggers a heavy git blame again?
                // NO, Git Blame is heavy. We should Cache the result or Filter in Frontend.
                // Since I modified the backend to filter, let's use it BUT we need the list of authors first.
                // Best approach: Fetch ALL stats (no author filter) first. Populate Dropdown. Then if user selects author, just filter the DISPLAY data in JS?
                // YES, Frontend filtering is much faster and avoids re-running `git blame`.
                // Let's ignore the backend `author` param for the UI display to avoid re-fetching.
                
                // However, the prompt implies "Selection".
                // Let's modify: Fetch ALL data. Populate Dropdown. Filter Data in JS.
                
                const data = await request(url);
                
                // Store/Update all authors list only if we fetched everything (no filter applied yet logic)
                // Actually we always fetch everything from backend now (unless we pass author param).
                // I will NOT pass author param to backend to allow frontend filtering without re-fetch.
                
                allAuthors = data.authors;
                updateAuthorDropdown();
                
                renderStats(data);
                
                // Commits might still need backend filter if list is huge? 
                // Commits API doesn't support author filter yet. Let's leave it for now or filter in JS if we fetch all.
                loadCommits(repoKey, branch, since, until, author);
            } catch (e) {
                // Handled
            } finally {
                if (btn) btn.disabled = false;
            }
        }
        
        function updateAuthorDropdown() {
            const select = document.getElementById('statsAuthorSelect');
            const current = select.value;
            // Only refill if empty or if list changed drastically?
            // Simple: Refill every time but try to keep selection
            
            // Get unique authors
            const authors = allAuthors.map(a => a.name).sort();
            
            // Keep "All" option
            let html = '<option value="">全部</option>';
            authors.forEach(name => {
                html += `<option value="${name}">${name}</option>`;
            });
            select.innerHTML = html;
            select.value = current;
        }
        
        function renderStats(data) {
            const selectedAuthor = document.getElementById('statsAuthorSelect').value;
            
            let displayAuthors = data.authors;
            let displayTotal = data.total_lines;
            
            if (selectedAuthor) {
                displayAuthors = data.authors.filter(a => a.name === selectedAuthor);
                displayTotal = displayAuthors.reduce((sum, a) => sum + a.total_lines, 0);
            }
            
            document.getElementById('totalLines').innerText = displayTotal.toLocaleString();
            document.getElementById('totalAuthors').innerText = displayAuthors.length;
            
            // Pie Chart
            if (!pieChart) pieChart = echarts.init(document.getElementById('pieChart'));
            pieChart.setOption({
                tooltip: { trigger: 'item' },
                series: [{
                    type: 'pie',
                    radius: '50%',
                    data: displayAuthors.map(a => ({value: a.total_lines, name: a.name})),
                    emphasis: { itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' } }
                }]
            });
            
            // Line Chart
            if (!lineChart) lineChart = echarts.init(document.getElementById('lineChart'));
            lineChart.setOption({
                title: { text: '暂无趋势数据', left: 'center', textStyle: { color: '#ccc' } },
                xAxis: { type: 'category', data: [] },
                yAxis: { type: 'value' },
                series: []
            });
        }
        
        async function loadCommits(repoKey, branch, since, until, authorFilter) {
            try {
                const commits = await request(`/stats/commits?repo_key=${repoKey}&branch=${encodeURIComponent(branch)}&since=${since}&until=${until}`);
                const tbody = document.getElementById('commitsList');
                tbody.innerHTML = '';
                
                if (!commits || commits.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">无提交记录</td></tr>';
                    return;
                }

                let filtered = commits;
                if (authorFilter) {
                    filtered = commits.filter(c => c.author === authorFilter);
                }

                filtered.slice(0, 100).forEach(c => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><span class="font-monospace" title="${c.hash}">${c.hash.substring(0,7)}</span></td>
                        <td>${c.author}</td>
                        <td>${new Date(c.date).toLocaleString()}</td>
                        <td class="text-break">${c.message}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                // Handled
            }
        }
        
        function exportStatsCSV() {
             const repoKey = document.getElementById('statsRepoSelect').value;
            const branch = document.getElementById('statsBranchSelect').value;
            const author = document.getElementById('statsAuthorSelect').value;
            const since = document.getElementById('statsSince').value;
            const until = document.getElementById('statsUntil').value;
            
            if (!repoKey || !branch) {
                showToast("请先选择仓库和分支", "warning");
                return;
            }
            // Pass author param to backend for filtered CSV
            let url = `/api/stats/export/csv?repo_key=${repoKey}&branch=${encodeURIComponent(branch)}&since=${since}&until=${until}`;
            if (author) {
                url += `&author=${encodeURIComponent(author)}`;
            }
            window.location.href = url;
        }
    </script>
</body>
</html>
