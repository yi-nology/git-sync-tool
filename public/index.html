<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Git 同步工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { max_width: 1000px; margin-top: 20px; }
        .card { margin-bottom: 20px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Git 同步工具</a>
        </div>
    </nav>

    <div class="container">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button">同步历史</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button">同步任务</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="repos-tab" data-bs-toggle="tab" data-bs-target="#repos" type="button">仓库管理</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button">设置</button>
            </li>
        </ul>

        <div class="tab-content pt-3" id="myTabContent">
            <!-- History Tab -->
            <div class="tab-pane fade show active" id="history" role="tabpanel">
                <div class="d-flex justify-content-between mb-3">
                    <h4>同步历史</h4>
                    <button class="btn btn-sm btn-outline-secondary" onclick="loadHistory()">刷新</button>
                </div>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>任务ID</th>
                            <th>状态</th>
                            <th>耗时</th>
                            <th>信息</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="history-list"></tbody>
                </table>
            </div>

            <!-- Tasks Tab -->
            <div class="tab-pane fade" id="tasks" role="tabpanel">
                <div class="d-flex justify-content-between mb-3">
                    <h4>同步任务</h4>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTaskModal">新建任务</button>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>源</th>
                            <th>目标</th>
                            <th>Cron</th>
                            <th>启用</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="task-list">
                        <tr>
                            <td colspan="6" class="text-center">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Repos Tab -->
            <div class="tab-pane fade" id="repos" role="tabpanel">
                <div class="d-flex justify-content-between mb-3">
                    <h4>仓库列表</h4>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addRepoModal">注册仓库</button>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>名称</th>
                            <th>路径</th>
                        </tr>
                    </thead>
                    <tbody id="repo-list"></tbody>
                </table>
            </div>

            <!-- Settings Tab -->
            <div class="tab-pane fade" id="settings" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">系统配置</h5>
                        <div class="form-check form-switch mt-3">
                            <input class="form-check-input" type="checkbox" id="debugModeSwitch" onchange="toggleDebugMode()">
                            <label class="form-check-label" for="debugModeSwitch">开启调试模式 (Debug Mode)</label>
                        </div>
                        <div class="form-text mt-2">开启后，系统将在后台日志中输出详细的 Git 命令执行信息。</div>
                    </div>
                </div>
                <div class="card mt-3">
                     <div class="card-body">
                        <h5 class="card-title">API 文档</h5>
                        <p>查看在线 Swagger 文档：<a href="/swagger.html" target="_blank">Swagger UI</a></p>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Repo Modal -->
    <div class="modal fade" id="addRepoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">注册仓库</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addRepoForm">
                        <div class="mb-3">
                            <label class="form-label">名称</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">本地路径 (绝对路径)</label>
                            <input type="text" class="form-control" name="path" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="submitRepo()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal fade" id="addTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">创建同步任务</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addTaskForm">
                        <div class="mb-3">
                            <label class="form-label">源仓库</label>
                            <select class="form-select" name="source_repo_id" id="sourceRepoSelect" onchange="updateTargetRepo(this.value)" required></select>
                        </div>
                        <div class="row">
                            <div class="col">
                                <label class="form-label">源 Remote</label>
                                <input type="text" class="form-control" name="source_remote" value="origin" required>
                            </div>
                            <div class="col">
                                <label class="form-label">源分支</label>
                                <input type="text" class="form-control" name="source_branch" value="main" required>
                            </div>
                        </div>
                        <div class="mb-3 mt-3">
                            <label class="form-label">目标仓库</label>
                            <select class="form-select" name="target_repo_id" id="targetRepoSelect" required></select>
                        </div>
                        <div class="row">
                            <div class="col">
                                <label class="form-label">目标 Remote</label>
                                <input type="text" class="form-control" name="target_remote" value="ky" required>
                            </div>
                            <div class="col">
                                <label class="form-label">目标分支</label>
                                <input type="text" class="form-control" name="target_branch" value="main" required>
                            </div>
                        </div>
                        <div class="mb-3 mt-3">
                            <label class="form-label">Push 选项</label>
                            <input type="text" class="form-control" name="push_options" placeholder="例如: --force --no-verify">
                            <div class="form-text">可选参数，将直接传递给 git push 命令</div>
                        </div>
                        <div class="mb-3 mt-3">
                            <label class="form-label">Cron 表达式</label>
                            <input type="text" class="form-control" name="cron" placeholder="0 2 * * *">
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="enabled" checked>
                            <label class="form-check-label">启用</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="submitTask()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div class="modal fade" id="editTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑同步任务</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editTaskForm">
                        <input type="hidden" name="id">
                        <div class="mb-3">
                            <label class="form-label">源仓库</label>
                            <select class="form-select" name="source_repo_id" id="editSourceRepoSelect" onchange="updateEditTargetRepo(this.value)" required></select>
                        </div>
                        <div class="row">
                            <div class="col">
                                <label class="form-label">源 Remote</label>
                                <input type="text" class="form-control" name="source_remote" required>
                            </div>
                            <div class="col">
                                <label class="form-label">源分支</label>
                                <input type="text" class="form-control" name="source_branch" required>
                            </div>
                        </div>
                        <div class="mb-3 mt-3">
                            <label class="form-label">目标仓库</label>
                            <select class="form-select" name="target_repo_id" id="editTargetRepoSelect" required></select>
                        </div>
                        <div class="row">
                            <div class="col">
                                <label class="form-label">目标 Remote</label>
                                <input type="text" class="form-control" name="target_remote" required>
                            </div>
                            <div class="col">
                                <label class="form-label">目标分支</label>
                                <input type="text" class="form-control" name="target_branch" required>
                            </div>
                        </div>
                        <div class="mb-3 mt-3">
                            <label class="form-label">Push 选项</label>
                            <input type="text" class="form-control" name="push_options" placeholder="例如: --force --no-verify">
                            <div class="form-text">可选参数，将直接传递给 git push 命令</div>
                        </div>
                        <div class="mb-3 mt-3">
                            <label class="form-label">Cron 表达式</label>
                            <input type="text" class="form-control" name="cron" placeholder="0 2 * * *">
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="enabled">
                            <label class="form-check-label">启用</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="submitEditTask()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Modal -->
    <div class="modal fade" id="logModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">执行日志</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <pre id="logContent" style="background: #f8f9fa; padding: 10px; max-height: 500px; overflow-y: auto; white-space: pre-wrap;"></pre>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/api';

        // Load data on start
        document.addEventListener('DOMContentLoaded', () => {
            loadHistory();
            loadRepos();
            loadTasks();
            loadConfig();
        });

        async function loadConfig() {
            try {
                const res = await fetch(`${API_BASE}/config`);
                const data = await res.json();
                document.getElementById('debugModeSwitch').checked = data.debug_mode;
            } catch (e) {
                console.error("Failed to load config", e);
            }
        }

        async function toggleDebugMode() {
            const enabled = document.getElementById('debugModeSwitch').checked;
            try {
                await fetch(`${API_BASE}/config`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({debug_mode: enabled})
                });
            } catch (e) {
                alert("设置失败");
                // Revert
                document.getElementById('debugModeSwitch').checked = !enabled;
            }
        }

        async function loadHistory() {
            const res = await fetch(`${API_BASE}/sync/history`);
            const data = await res.json();
            const tbody = document.getElementById('history-list');
            tbody.innerHTML = '';
            data.forEach(run => {
                const tr = document.createElement('tr');
                const duration = run.end_time ? (new Date(run.end_time) - new Date(run.start_time)) + 'ms' : '-';
                tr.innerHTML = `
                    <td>${new Date(run.start_time).toLocaleString()}</td>
                    <td>${run.task_id}</td>
                    <td><span class="badge bg-${getStatusColor(run.status)}">${run.status}</span></td>
                    <td>${duration}</td>
                    <td>${run.error_message || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick='showLog(${JSON.stringify(run.details || "暂无日志")})'>查看日志</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function showLog(details) {
            document.getElementById('logContent').textContent = details;
            new bootstrap.Modal(document.getElementById('logModal')).show();
        }

        function getStatusColor(status) {
            if (status === 'success') return 'success';
            if (status === 'failed') return 'danger';
            if (status === 'conflict') return 'warning';
            return 'secondary';
        }

        async function loadRepos() {
            const res = await fetch(`${API_BASE}/repos`);
            const data = await res.json();
            const tbody = document.getElementById('repo-list');
            tbody.innerHTML = '';
            const sourceSelect = document.getElementById('sourceRepoSelect');
            const targetSelect = document.getElementById('targetRepoSelect');
            sourceSelect.innerHTML = '';
            targetSelect.innerHTML = '';

            data.forEach(repo => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${repo.id}</td><td>${repo.name}</td><td>${repo.path}</td>`;
                tbody.appendChild(tr);

                const option = `<option value="${repo.id}">${repo.name}</option>`;
                sourceSelect.innerHTML += option;
                targetSelect.innerHTML += option;
            });
        }

        async function submitRepo() {
            const form = document.getElementById('addRepoForm');
            const data = {
                name: form.name.value,
                path: form.path.value
            };
            const res = await fetch(`${API_BASE}/repos`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if (res.ok) {
                bootstrap.Modal.getInstance(document.getElementById('addRepoModal')).hide();
                loadRepos();
                form.reset();
            } else {
                alert('添加仓库失败');
            }
        }

        async function loadTasks() {
            const res = await fetch(`${API_BASE}/sync/tasks`);
            const data = await res.json();
            const tbody = document.getElementById('task-list');
            tbody.innerHTML = '';
            data.forEach(task => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${task.id}</td>
                    <td>${task.source_repo.name} (${task.source_remote}/${task.source_branch})</td>
                    <td>${task.target_repo.name} (${task.target_remote}/${task.target_branch})</td>
                    <td>${task.cron || '-'}</td>
                    <td>${task.enabled ? '是' : '否'}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="runTask(${task.id})">运行</button>
                        <button class="btn btn-sm btn-secondary" onclick="editTask(${task.id})">编辑</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateTargetRepo(sourceId) {
            // For now, just keep them independent, user can select whatever.
            // Or auto-select same repo if "origin->ky"
            document.getElementById('targetRepoSelect').value = sourceId;
        }

        function updateEditTargetRepo(sourceId) {
            document.getElementById('editTargetRepoSelect').value = sourceId;
        }

        async function editTask(id) {
            const res = await fetch(`${API_BASE}/sync/tasks/${id}`);
            if (!res.ok) {
                alert('获取任务失败');
                return;
            }
            const task = await res.json();
            
            // Populate form
            const form = document.getElementById('editTaskForm');
            form.id.value = task.id;
            
            // Need to populate selects first
            const reposRes = await fetch(`${API_BASE}/repos`);
            const repos = await reposRes.json();
            const sourceSelect = document.getElementById('editSourceRepoSelect');
            const targetSelect = document.getElementById('editTargetRepoSelect');
            sourceSelect.innerHTML = '';
            targetSelect.innerHTML = '';
            
            repos.forEach(repo => {
                const option = `<option value="${repo.id}">${repo.name}</option>`;
                sourceSelect.innerHTML += option;
                targetSelect.innerHTML += option;
            });
            
            form.source_repo_id.value = task.source_repo_id;
            form.source_remote.value = task.source_remote;
            form.source_branch.value = task.source_branch;
            form.target_repo_id.value = task.target_repo_id;
            form.target_remote.value = task.target_remote;
            form.target_branch.value = task.target_branch;
            form.push_options.value = task.push_options || '';
            form.cron.value = task.cron || '';
            form.enabled.checked = task.enabled;
            
            new bootstrap.Modal(document.getElementById('editTaskModal')).show();
        }

        async function submitEditTask() {
            const form = document.getElementById('editTaskForm');
            const id = form.id.value;
            const data = {
                source_repo_id: parseInt(form.source_repo_id.value),
                source_remote: form.source_remote.value,
                source_branch: form.source_branch.value,
                target_repo_id: parseInt(form.target_repo_id.value),
                target_remote: form.target_remote.value,
                target_branch: form.target_branch.value,
                push_options: form.push_options.value,
                cron: form.cron.value,
                enabled: form.enabled.checked
            };
            
            const res = await fetch(`${API_BASE}/sync/tasks/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                bootstrap.Modal.getInstance(document.getElementById('editTaskModal')).hide();
                loadTasks();
            } else {
                alert('更新任务失败');
            }
        }
        
        async function submitTask() {
            const form = document.getElementById('addTaskForm');
            const data = {
                source_repo_id: parseInt(form.source_repo_id.value),
                source_remote: form.source_remote.value,
                source_branch: form.source_branch.value,
                target_repo_id: parseInt(form.target_repo_id.value),
                target_remote: form.target_remote.value,
                target_branch: form.target_branch.value,
                push_options: form.push_options.value,
                cron: form.cron.value,
                enabled: form.enabled.checked
            };
            const res = await fetch(`${API_BASE}/sync/tasks`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if (res.ok) {
                bootstrap.Modal.getInstance(document.getElementById('addTaskModal')).hide();
                loadTasks();
                form.reset();
            } else {
                alert('创建任务失败');
            }
        }

        async function runTask(id) {
            const res = await fetch(`${API_BASE}/sync/run`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({task_id: id})
            });
            if (res.ok) {
                alert('同步已开始');
                setTimeout(loadHistory, 1000);
            } else {
                alert('启动同步失败');
            }
        }
    </script>
</body>
</html>
