import{aA as fe,r as d,v as _e,k as ye,D as m,G as x,E as e,F as a,P as ge,u as b,z as F,ac as n,ad as he,y as r,S as i,U as C,M as T,a6 as N,R as z,I as be,aB as ke}from"./vendor-BwpG93hR.js";import{p as Ve,v as we,s as Ce,r as Re,a as Ue,t as xe,E as Le,b as L,f as Se}from"./element-plus-BS7CnCwq.js";import{g as $e,a as De,d as Te,s as ze,c as Be,b as Pe,e as Fe}from"./repo-DyMh5937.js";import{g as Ie,t as Ne,l as qe}from"./system-IA1MElDq.js";import{_ as Ee}from"./index-Bev_lS0N.js";import"./request-BBaptrTN.js";const Me=fe("repo",()=>{const I=d([]),S=d(null),v=d(!1);async function k(){v.value=!0;try{I.value=await $e()}finally{v.value=!1}}async function R(y){v.value=!0;try{S.value=await De(y)}finally{v.value=!1}}function B(y){return I.value.find(P=>P.key===y)}return{repoList:I,currentRepo:S,loading:v,fetchRepoList:k,fetchRepoDetail:R,getRepoByKey:B}}),He={class:"repo-list-page"},Ke={class:"page-header"},Ae={key:0,class:"scan-result"},je={key:0},Ge={key:2,class:"clone-progress"},We={class:"clone-log"},Je={class:"file-browser"},Oe={class:"browser-header"},Qe={class:"dir-list"},Xe=["onClick"],Ye=_e({__name:"RepoListPage",setup(I){const S=ke(),v=Me(),k=d(!1),R=d("local"),B=d(!1),y=d(!1),P=d(""),K=d([]),s=d({name:"",path:"",config_source:"local"}),o=d({remote_url:"",local_path:"",name:"",auth_type:"none",auth_key:"",auth_secret:""}),V=d(null),q=d(!1),U=d(null),g=d({active:!1,status:"",logs:[]}),w=d({parent:"",current:"",dirs:[]});ye(async()=>{await v.fetchRepoList();try{K.value=await Ie()}catch{}});function Y(u){S.push(`/repos/${u}`)}function Z(u){S.push(`/repos/${u}/branches`)}function ee(u){S.push(`/repos/${u}/sync`)}async function le(u,l){try{await Le.confirm(`确定要删除仓库 "${l}" 吗？如果被同步任务使用将无法删除。`,"确认删除",{type:"warning"}),await Te(u),L.success("仓库已删除"),await v.fetchRepoList()}catch{}}async function A(){if(s.value.path){if(!s.value.name){const u=s.value.path.split("/");s.value.name=u[u.length-1]||u[u.length-2]||""}try{V.value=await ze(s.value.path)}catch{V.value=null}}}function ae(){if(!o.value.remote_url)return;const u=o.value.remote_url.split("/");let l=u[u.length-1]||"";l.endsWith(".git")&&(l=l.slice(0,-4)),o.value.name||(o.value.name=l)}async function te(){if(!o.value.remote_url){L.warning("请输入 URL");return}q.value=!0,U.value=null;try{const u=await Ne(o.value.remote_url);U.value={success:u.status==="success",message:u.status==="success"?"连接成功":`失败: ${u.error}`}}catch{U.value={success:!1,message:"请求错误"}}finally{q.value=!1}}async function oe(){B.value=!0;try{if(R.value==="local"){if(!s.value.name||!s.value.path){L.warning("请填写完整信息");return}const u=V.value?.remotes||[];await Be({name:s.value.name,path:s.value.path,config_source:s.value.config_source,auth_type:"none",remotes:u,remote_auths:{}}),L.success("仓库注册成功"),k.value=!1,j(),await v.fetchRepoList()}else{if(!o.value.remote_url||!o.value.local_path){L.warning("请填写完整克隆信息");return}const u=await Pe({remote_url:o.value.remote_url,local_path:o.value.local_path,name:o.value.name,auth_type:o.value.auth_type==="none"?void 0:o.value.auth_type,auth_key:o.value.auth_key||void 0,auth_secret:o.value.auth_secret||void 0,config_source:"database"});ue(u.task_id)}}finally{B.value=!1}}function ue(u){g.value={active:!0,status:"running",logs:["Initializing..."]};const l=setInterval(async()=>{try{const c=await Fe(u);c.progress&&(g.value.logs=c.progress),c.status==="success"?(clearInterval(l),g.value.status="success",L.success("克隆成功"),k.value=!1,j(),await v.fetchRepoList()):c.status==="failed"&&(clearInterval(l),g.value.status="failed",L.error("克隆失败: "+c.error))}catch{}},1e3)}function j(){s.value={name:"",path:"",config_source:"local"},o.value={remote_url:"",local_path:"",name:"",auth_type:"none",auth_key:"",auth_secret:""},V.value=null,U.value=null,g.value={active:!1,status:"",logs:[]}}async function E(u){try{w.value=await qe(u||"",P.value)}catch{}}async function ne(){await E(w.value.current)}function se(){R.value==="local"?s.value.path=w.value.current:o.value.local_path=w.value.current,y.value=!1,R.value==="local"&&A()}return(u,l)=>{const c=n("el-icon"),f=n("el-button"),h=n("el-table-column"),M=n("el-text"),G=n("el-tag"),re=n("el-button-group"),W=n("el-table"),_=n("el-input"),p=n("el-form-item"),ie=n("el-divider"),$=n("el-option"),H=n("el-select"),J=n("el-form"),O=n("el-tab-pane"),Q=n("el-col"),de=n("el-row"),pe=n("el-alert"),me=n("el-tabs"),X=n("el-dialog"),ve=n("el-empty"),ce=he("loading");return r(),m("div",He,[x("div",Ke,[l[21]||(l[21]=x("h2",null,"仓库列表",-1)),e(f,{type:"primary",onClick:l[0]||(l[0]=t=>k.value=!0)},{default:a(()=>[e(c,null,{default:a(()=>[e(b(Ve))]),_:1}),l[20]||(l[20]=i(" 注册仓库 ",-1))]),_:1})]),ge((r(),F(W,{data:b(v).repoList,stripe:""},{default:a(()=>[e(h,{prop:"id",label:"ID",width:"60"}),e(h,{prop:"name",label:"名称","min-width":"120"}),e(h,{prop:"path",label:"路径","min-width":"200"},{default:a(({row:t})=>[e(M,{type:"info",size:"small",class:"mono-text"},{default:a(()=>[i(C(t.path),1)]),_:2},1024)]),_:1}),e(h,{prop:"config_source",label:"配置来源",width:"110"},{default:a(({row:t})=>[e(G,{size:"small",type:t.config_source==="database"?"warning":"info"},{default:a(()=>[i(C(t.config_source==="database"?"数据库":"本地文件"),1)]),_:2},1032,["type"])]),_:1}),e(h,{prop:"remote_url",label:"远程","min-width":"180"},{default:a(({row:t})=>[e(M,{size:"small",truncated:""},{default:a(()=>[i(C(t.remote_url||"-"),1)]),_:2},1024)]),_:1}),e(h,{label:"操作",width:"260",fixed:"right"},{default:a(({row:t})=>[e(re,{size:"small"},{default:a(()=>[e(f,{type:"primary",onClick:D=>Y(t.key)},{default:a(()=>[e(c,null,{default:a(()=>[e(b(we))]),_:1}),l[22]||(l[22]=i(" 详情 ",-1))]),_:1},8,["onClick"]),e(f,{type:"success",onClick:D=>Z(t.key)},{default:a(()=>[e(c,null,{default:a(()=>[e(b(Ce))]),_:1}),l[23]||(l[23]=i(" 分支 ",-1))]),_:1},8,["onClick"]),e(f,{type:"warning",onClick:D=>ee(t.key)},{default:a(()=>[e(c,null,{default:a(()=>[e(b(Re))]),_:1}),l[24]||(l[24]=i(" 同步 ",-1))]),_:1},8,["onClick"]),e(f,{type:"danger",onClick:D=>le(t.key,t.name)},{default:a(()=>[e(c,null,{default:a(()=>[e(b(Ue))]),_:1})]),_:1},8,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[ce,b(v).loading]]),e(X,{modelValue:k.value,"onUpdate:modelValue":l[16]||(l[16]=t=>k.value=t),title:"注册仓库",width:"700px","destroy-on-close":""},{footer:a(()=>[e(f,{onClick:l[15]||(l[15]=t=>k.value=!1)},{default:a(()=>[...l[31]||(l[31]=[i("取消",-1)])]),_:1}),e(f,{type:"primary",onClick:oe,loading:B.value},{default:a(()=>[...l[32]||(l[32]=[i("保存",-1)])]),_:1},8,["loading"])]),default:a(()=>[e(me,{modelValue:R.value,"onUpdate:modelValue":l[14]||(l[14]=t=>R.value=t)},{default:a(()=>[e(O,{label:"接入现有仓库",name:"local"},{default:a(()=>[e(J,{model:s.value,"label-width":"100px"},{default:a(()=>[e(p,{label:"本地路径",required:""},{default:a(()=>[e(_,{modelValue:s.value.path,"onUpdate:modelValue":l[2]||(l[2]=t=>s.value.path=t),placeholder:"/path/to/repo",onBlur:A},{append:a(()=>[e(f,{onClick:l[1]||(l[1]=t=>y.value=!0)},{default:a(()=>[...l[25]||(l[25]=[i("浏览...",-1)])]),_:1})]),_:1},8,["modelValue"]),l[26]||(l[26]=x("div",{class:"form-tip"},"输入路径后将自动扫描 .git/config",-1))]),_:1}),e(p,{label:"仓库名称",required:""},{default:a(()=>[e(_,{modelValue:s.value.name,"onUpdate:modelValue":l[3]||(l[3]=t=>s.value.name=t),placeholder:"my-project"},null,8,["modelValue"])]),_:1}),V.value?(r(),m("div",Ae,[e(ie,{"content-position":"left"},{default:a(()=>[...l[27]||(l[27]=[i("解析结果",-1)])]),_:1}),e(p,{label:"远程仓库"},{default:a(()=>[e(W,{data:V.value.remotes,size:"small",border:""},{default:a(()=>[e(h,{prop:"name",label:"Name",width:"100"}),e(h,{prop:"fetch_url",label:"Fetch URL"}),e(h,{prop:"push_url",label:"Push URL"})]),_:1},8,["data"])]),_:1}),e(p,{label:"分支追踪"},{default:a(()=>[V.value.branches?.length?(r(),m("div",je,[(r(!0),m(T,null,N(V.value.branches,t=>(r(),F(G,{key:t.name,size:"small",class:"mr-1 mb-1"},{default:a(()=>[i(C(t.name)+" -> "+C(t.upstream_ref),1)]),_:2},1024))),128))])):(r(),F(M,{key:1,type:"info"},{default:a(()=>[...l[28]||(l[28]=[i("无追踪分支",-1)])]),_:1}))]),_:1})])):z("",!0),e(p,{label:"配置来源"},{default:a(()=>[e(H,{modelValue:s.value.config_source,"onUpdate:modelValue":l[4]||(l[4]=t=>s.value.config_source=t)},{default:a(()=>[e($,{label:"本地配置文件 (.git/config)",value:"local"}),e($,{label:"数据库托管",value:"database"})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1}),e(O,{label:"克隆新仓库",name:"clone"},{default:a(()=>[e(J,{model:o.value,"label-width":"100px"},{default:a(()=>[e(p,{label:"远程 URL",required:""},{default:a(()=>[e(_,{modelValue:o.value.remote_url,"onUpdate:modelValue":l[5]||(l[5]=t=>o.value.remote_url=t),placeholder:"https://github.com/user/repo.git",onChange:ae},{append:a(()=>[e(f,{onClick:te,loading:q.value},{default:a(()=>[...l[29]||(l[29]=[i("测试连接",-1)])]),_:1},8,["loading"])]),_:1},8,["modelValue"]),U.value?(r(),m("div",{key:0,class:be(["form-tip",U.value.success?"text-success":"text-danger"])},C(U.value.message),3)):z("",!0)]),_:1}),e(de,{gutter:16},{default:a(()=>[e(Q,{span:12},{default:a(()=>[e(p,{label:"本地路径",required:""},{default:a(()=>[e(_,{modelValue:o.value.local_path,"onUpdate:modelValue":l[7]||(l[7]=t=>o.value.local_path=t),placeholder:"/data/repos/my-repo"},{append:a(()=>[e(f,{onClick:l[6]||(l[6]=t=>y.value=!0)},{default:a(()=>[...l[30]||(l[30]=[i("浏览...",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(Q,{span:12},{default:a(()=>[e(p,{label:"仓库名称",required:""},{default:a(()=>[e(_,{modelValue:o.value.name,"onUpdate:modelValue":l[8]||(l[8]=t=>o.value.name=t)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(p,{label:"认证方式"},{default:a(()=>[e(H,{modelValue:o.value.auth_type,"onUpdate:modelValue":l[9]||(l[9]=t=>o.value.auth_type=t)},{default:a(()=>[e($,{label:"无 (公开仓库)",value:"none"}),e($,{label:"SSH 密钥",value:"ssh"}),e($,{label:"账号密码 (HTTP/HTTPS)",value:"http"})]),_:1},8,["modelValue"])]),_:1}),o.value.auth_type==="ssh"?(r(),m(T,{key:0},[e(p,{label:"私钥路径"},{default:a(()=>[e(H,{modelValue:o.value.auth_key,"onUpdate:modelValue":l[10]||(l[10]=t=>o.value.auth_key=t),filterable:"","allow-create":"",placeholder:"~/.ssh/id_rsa"},{default:a(()=>[(r(!0),m(T,null,N(K.value,t=>(r(),F($,{key:t,label:t,value:t},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(p,{label:"密码"},{default:a(()=>[e(_,{modelValue:o.value.auth_secret,"onUpdate:modelValue":l[11]||(l[11]=t=>o.value.auth_secret=t),type:"password",placeholder:"Passphrase (可选)","show-password":""},null,8,["modelValue"])]),_:1})],64)):z("",!0),o.value.auth_type==="http"?(r(),m(T,{key:1},[e(p,{label:"用户名"},{default:a(()=>[e(_,{modelValue:o.value.auth_key,"onUpdate:modelValue":l[12]||(l[12]=t=>o.value.auth_key=t)},null,8,["modelValue"])]),_:1}),e(p,{label:"密码/Token"},{default:a(()=>[e(_,{modelValue:o.value.auth_secret,"onUpdate:modelValue":l[13]||(l[13]=t=>o.value.auth_secret=t),type:"password","show-password":""},null,8,["modelValue"])]),_:1})],64)):z("",!0),g.value.active?(r(),m("div",Ge,[e(pe,{title:g.value.status==="failed"?"克隆失败":"正在克隆...",type:g.value.status==="failed"?"error":"info",closable:!1,"show-icon":""},null,8,["title","type"]),x("div",We,[(r(!0),m(T,null,N(g.value.logs,(t,D)=>(r(),m("div",{key:D},C(t),1))),128))])])):z("",!0)]),_:1},8,["model"])]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue"]),e(X,{modelValue:y.value,"onUpdate:modelValue":l[19]||(l[19]=t=>y.value=t),title:"选择目录",width:"600px","destroy-on-close":""},{footer:a(()=>[e(f,{type:"primary",onClick:se},{default:a(()=>[...l[34]||(l[34]=[i("选择当前目录",-1)])]),_:1})]),default:a(()=>[x("div",Je,[x("div",Oe,[e(f,{onClick:l[17]||(l[17]=t=>E(w.value.parent)),icon:b(xe)},{default:a(()=>[...l[33]||(l[33]=[i("上一级",-1)])]),_:1},8,["icon"]),e(_,{"model-value":w.value.current,readonly:""},null,8,["model-value"])]),e(_,{modelValue:P.value,"onUpdate:modelValue":l[18]||(l[18]=t=>P.value=t),placeholder:"搜索当前目录...",onInput:ne,class:"mb-2"},null,8,["modelValue"]),x("div",Qe,[(r(!0),m(T,null,N(w.value.dirs,t=>(r(),m("div",{key:t.path,class:"dir-item",onClick:D=>E(t.path)},[e(c,null,{default:a(()=>[e(b(Se))]),_:1}),i(" "+C(t.name),1)],8,Xe))),128)),w.value.dirs?.length?z("",!0):(r(),F(ve,{key:0,description:"无子目录","image-size":60}))])])]),_:1},8,["modelValue"])])}}}),ul=Ee(Ye,[["__scopeId","data-v-8aea5419"]]);export{ul as default};
