import{v as se,k as ue,D as f,G as m,E as l,F as a,u,R as U,P as re,M as H,a6 as M,az as ie,r as p,ac as s,ad as ce,y as r,S as d,z as b,U as _,I as de}from"./vendor-BwpG93hR.js";import{e as _e,p as me,b as $,A as pe,C as fe,D as ve,h as ye,a as ge,F as be,G as ke,H as he,I as we,E as Ve}from"./element-plus-BS7CnCwq.js";import{s as k}from"./request-BBaptrTN.js";import{a as Ce,s as Te}from"./repo-DyMh5937.js";import{f as Se,g as De,b as xe}from"./format-B53pSo0L.js";import{_ as ze}from"./index-Bev_lS0N.js";function Ue(c){return k.get("/sync/tasks",{params:c?{repo_key:c}:{}})}function $e(c){return k.post("/sync/task/create",c)}function Le(c){return k.post("/sync/task/update",c)}function Ee(c){return k.post("/sync/task/delete",{key:c})}function Be(c){return k.post("/sync/run",{task_key:c})}function Ne(c){return k.get("/sync/history",{params:{}})}const Re={class:"sync-task-page"},Fe={class:"page-header"},He={class:"header-left"},Me={key:0,class:"text-center"},Pe={class:"task-header"},Ie={class:"task-title"},Ae={class:"task-actions"},Ge={class:"task-meta"},Ke={key:0},je={key:1},qe={class:"log-content"},Je=se({__name:"SyncTaskPage",setup(c){const v=ie().params.repoKey,V=p(!1),L=p(!1),E=p([]),C=p([]),g=p(!1),h=p(null),n=p({source_remote:"local",source_branch:"main",target_remote:"",target_branch:"main",push_options:"",cron:"",enabled:!0}),B=p(!1),P=p([]),N=p(!1),I=p("");function j(o){return o.source_remote==="local"?"success":o.target_remote==="local"?"warning":"primary"}ue(async()=>{await R();try{const o=await Ce(v);if(o?.path){const t=await Te(o.path);C.value=(t.remotes||[]).map(i=>i.name)}}catch{}});async function R(){V.value=!0;try{E.value=await Ue(v)}finally{V.value=!1}}function q(){h.value=null,n.value={source_remote:"local",source_branch:"main",target_remote:C.value[0]||"",target_branch:"main",push_options:"",cron:"",enabled:!0},g.value=!0}function J(o){h.value=o,n.value={source_remote:o.source_remote,source_branch:o.source_branch,target_remote:o.target_remote,target_branch:o.target_branch,push_options:o.push_options,cron:o.cron,enabled:o.enabled},g.value=!0}async function O(){if(n.value.source_remote===n.value.target_remote){$.warning("源和目标不能相同");return}L.value=!0;try{h.value?await Le({key:h.value.key,source_repo_key:v,target_repo_key:v,...n.value}):await $e({source_repo_key:v,target_repo_key:v,...n.value}),$.success("保存成功"),g.value=!1,await R()}finally{L.value=!1}}async function Q(o){try{await Be(o),$.success("任务已触发")}catch{}}async function W(o){try{await Ve.confirm("确定删除该同步规则吗？","确认删除",{type:"warning"}),await Ee(o),$.success("删除成功"),await R()}catch{}}async function X(o){try{const t=await Ne();P.value=t.filter(i=>i.task_key===o),B.value=!0}catch{}}function Y(o){I.value=o||"无详情",N.value=!0}return(o,t)=>{const i=s("el-button"),w=s("el-icon"),Z=s("el-empty"),A=s("el-tag"),ee=s("el-card"),T=s("el-option"),G=s("el-select"),y=s("el-form-item"),S=s("el-input"),D=s("el-col"),K=s("el-row"),le=s("el-alert"),te=s("el-switch"),ae=s("el-form"),F=s("el-dialog"),x=s("el-table-column"),oe=s("el-table"),ne=ce("loading");return r(),f("div",Re,[m("div",Fe,[m("div",He,[l(i,{onClick:t[0]||(t[0]=e=>o.$router.push(`/repos/${u(v)}`)),icon:u(_e),text:""},{default:a(()=>[...t[12]||(t[12]=[d("返回",-1)])]),_:1},8,["icon"]),t[13]||(t[13]=m("h2",null,"同步任务",-1))]),l(i,{type:"primary",onClick:q},{default:a(()=>[l(w,null,{default:a(()=>[l(u(me))]),_:1}),t[14]||(t[14]=d(" 新建同步规则 ",-1))]),_:1})]),E.value.length===0&&!V.value?(r(),f("div",Me,[l(Z,{description:"暂无同步规则"})])):U("",!0),re((r(),f("div",null,[(r(!0),f(H,null,M(E.value,e=>(r(),b(ee,{key:e.key,class:de(["task-card",{disabled:!e.enabled}])},{default:a(()=>[m("div",Pe,[m("div",Ie,[l(A,{size:"small",type:j(e)},{default:a(()=>[d(_(u(xe)(e.source_remote,e.target_remote)),1)]),_:2},1032,["type"]),m("strong",null,_(e.source_remote)+"/"+_(e.source_branch),1),l(w,null,{default:a(()=>[l(u(pe))]),_:1}),m("strong",null,_(e.target_remote)+"/"+_(e.target_branch),1)]),m("div",Ae,[l(i,{size:"small",type:"success",onClick:z=>Q(e.key),icon:u(fe),circle:"",title:"立即执行"},null,8,["onClick","icon"]),l(i,{size:"small",type:"info",onClick:z=>X(e.key),icon:u(ve),circle:"",title:"历史记录"},null,8,["onClick","icon"]),l(i,{size:"small",onClick:z=>J(e),icon:u(ye),circle:"",title:"编辑"},null,8,["onClick","icon"]),l(i,{size:"small",type:"danger",onClick:z=>W(e.key),icon:u(ge),circle:"",title:"删除"},null,8,["onClick","icon"])])]),m("div",Ge,[e.cron?(r(),f("span",Ke,[l(w,null,{default:a(()=>[l(u(be))]),_:1}),d(" "+_(e.cron),1)])):U("",!0),m("span",null,[l(w,null,{default:a(()=>[e.enabled?(r(),b(u(ke),{key:0})):(r(),b(u(he),{key:1}))]),_:2},1024),d(" "+_(e.enabled?"已启用":"已禁用"),1)]),e.push_options?(r(),f("span",je,[l(w,null,{default:a(()=>[l(u(we))]),_:1}),d(" "+_(e.push_options),1)])):U("",!0)])]),_:2},1032,["class"]))),128))])),[[ne,V.value]]),l(F,{modelValue:g.value,"onUpdate:modelValue":t[9]||(t[9]=e=>g.value=e),title:h.value?"编辑同步规则":"新建同步规则",width:"650px","destroy-on-close":""},{footer:a(()=>[l(i,{onClick:t[8]||(t[8]=e=>g.value=!1)},{default:a(()=>[...t[15]||(t[15]=[d("取消",-1)])]),_:1}),l(i,{type:"primary",onClick:O,loading:L.value},{default:a(()=>[...t[16]||(t[16]=[d("保存",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(ae,{model:n.value,"label-width":"100px"},{default:a(()=>[l(K,{gutter:16},{default:a(()=>[l(D,{span:12},{default:a(()=>[l(y,{label:"源 (Source)"},{default:a(()=>[l(G,{modelValue:n.value.source_remote,"onUpdate:modelValue":t[1]||(t[1]=e=>n.value.source_remote=e),style:{width:"100%"}},{default:a(()=>[l(T,{label:"Local (本地)",value:"local"}),(r(!0),f(H,null,M(C.value,e=>(r(),b(T,{key:e,label:e,value:e},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(y,{label:"源分支"},{default:a(()=>[l(S,{modelValue:n.value.source_branch,"onUpdate:modelValue":t[2]||(t[2]=e=>n.value.source_branch=e),placeholder:"main"},null,8,["modelValue"])]),_:1})]),_:1}),l(D,{span:12},{default:a(()=>[l(y,{label:"目标 (Target)"},{default:a(()=>[l(G,{modelValue:n.value.target_remote,"onUpdate:modelValue":t[3]||(t[3]=e=>n.value.target_remote=e),style:{width:"100%"}},{default:a(()=>[l(T,{label:"Local (本地)",value:"local"}),(r(!0),f(H,null,M(C.value,e=>(r(),b(T,{key:e,label:e,value:e},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(y,{label:"目标分支"},{default:a(()=>[l(S,{modelValue:n.value.target_branch,"onUpdate:modelValue":t[4]||(t[4]=e=>n.value.target_branch=e),placeholder:"main"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),n.value.source_remote===n.value.target_remote?(r(),b(le,{key:0,title:"源和目标不能相同",type:"warning",closable:!1,"show-icon":"",class:"mb-3"})):U("",!0),l(y,{label:"Push 选项"},{default:a(()=>[l(S,{modelValue:n.value.push_options,"onUpdate:modelValue":t[5]||(t[5]=e=>n.value.push_options=e),placeholder:"例如: --force"},null,8,["modelValue"])]),_:1}),l(K,{gutter:16},{default:a(()=>[l(D,{span:12},{default:a(()=>[l(y,{label:"定时 (Cron)"},{default:a(()=>[l(S,{modelValue:n.value.cron,"onUpdate:modelValue":t[6]||(t[6]=e=>n.value.cron=e),placeholder:"0 2 * * * (留空禁用)"},null,8,["modelValue"])]),_:1})]),_:1}),l(D,{span:12},{default:a(()=>[l(y,{label:"启用"},{default:a(()=>[l(te,{modelValue:n.value.enabled,"onUpdate:modelValue":t[7]||(t[7]=e=>n.value.enabled=e)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(F,{modelValue:B.value,"onUpdate:modelValue":t[10]||(t[10]=e=>B.value=e),title:"同步历史",width:"700px"},{default:a(()=>[l(oe,{data:P.value,size:"small",border:""},{default:a(()=>[l(x,{prop:"start_time",label:"时间",width:"180"},{default:a(({row:e})=>[d(_(u(Se)(e.start_time)),1)]),_:1}),l(x,{prop:"status",label:"状态",width:"100"},{default:a(({row:e})=>[l(A,{type:u(De)(e.status),size:"small"},{default:a(()=>[d(_(e.status),1)]),_:2},1032,["type"])]),_:1}),l(x,{label:"耗时",width:"100"},{default:a(({row:e})=>[d(_(e.end_time?new Date(e.end_time).getTime()-new Date(e.start_time).getTime()+"ms":"-"),1)]),_:1}),l(x,{label:"详情"},{default:a(({row:e})=>[l(i,{size:"small",link:"",onClick:z=>Y(e.details)},{default:a(()=>[...t[17]||(t[17]=[d("日志",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1},8,["modelValue"]),l(F,{modelValue:N.value,"onUpdate:modelValue":t[11]||(t[11]=e=>N.value=e),title:"执行详情",width:"600px"},{default:a(()=>[m("pre",qe,_(I.value),1)]),_:1},8,["modelValue"])])}}}),ll=ze(Je,[["__scopeId","data-v-5cd5aaf8"]]);export{ll as default};
